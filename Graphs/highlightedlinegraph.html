<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Line Graph</title>
  <script type="text/javascript" src="d3/d3.js"></script>
  <style type="text/css">


svg {
  font: 10px sans-serif;
}

.y_axis path,
.y_axis line,
.x_axis path,
.x_axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke-width: 5px;
}

/*#tooltip {
        position: absolute;
        width: 100px;
        height: 100px;
        padding: 10px;
        background-color: blue;
        border-radius: 10px;
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        border-color: black;
        pointer-events: none;
      }
      
      #tooltip.hidden {
        display: none;
      }
      
      #tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 16px;
        line-height: 20px;
      }*/

div.tooltip { 
    position: absolute;     
    text-align: center;     
    width: 150px;          
    height: 30px;         
    padding: 2px;       
    font: 12px sans-serif;    
    background: white; 
    border: 1px solid black;    
    border-radius: 8px;     
    pointer-events: none;     
}

table{
  border: 1px solid black;
}

th, td{
  font: 10px sans-serif;
  text-align: center;
  width: 85px;
  height: 60px;
  /*padding: 15px;*/
  border: 1px solid black;
}

h1{
  margin-top: 20;
  margin-bottom: 0;
}

.innerDiv{
  display: inline-block;
}

.label{

}

  </style>
</head>
<body>

  <script type="text/javascript">

  var clicked_major;

  function findSemester(code){
    var baseNumber = parseInt(code) % 2000; // gives something like 114

    var year = Math.floor(baseNumber / 10); // 114 / 10 = 11

    var semester = baseNumber - (year*10); // 114 - 110 = 4

    var returnString;
    switch(semester){
      case 4: returnString = "Fall "; break;
      case 1: returnString = "Spring "; break;
      default: returnString = "Unknown"; break;
    }

    returnString = returnString + /*"20" + */year;
    return returnString;
  }

  var margin = {top: 20, right: 100, bottom: 70, left: 50},
  width = 400 - margin.left - margin.right,
  height = 600 - margin.top - margin.bottom;

  var x = d3.scale.ordinal()
    .domain([findSemester("2104"), findSemester("2111"), findSemester("2114"), findSemester("2121"), findSemester("2124"), findSemester("2131"), findSemester("2134"), findSemester("2141"), findSemester("2144"), findSemester("2151")])
    .rangePoints([0, width]);

var y = d3.scale.log()
    .range([height, 0]);

var diffY = d3.scale.linear()
            .domain([-10, 10])
            .range([height, 0]);

var color = d3.scale.category20();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var diffxAxis = d3.svg.axis()
    .scale(x)
    .orient("center");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(30, ",.1s");

var diffyAxis = d3.svg.axis()
    .scale(diffY)
    .orient("left")
    .ticks(10, ",.1s");

var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

var line = d3.svg.line()
    .interpolate("linear")
    .x(function(d) { /*console.log("semester: " + d.key);*/ return x(findSemester(d.key)); })
    .y(function(d) { /*console.log("number people: " + d.values.length);*/ return y(d.values.length); });

var csv_data;
var nested_data;
var gender_data;
var flipped_data;
var ethnicity_data;
var resident_data;

  d3.csv("newData3.csv", function(error, data){
    if (error) { console.log(error); }
    else{
      console.log("Success!");
      color.domain(d3.keys(data[0]).filter(function(key) { return key == "plan_descr"; }));

      csv_data = data;

      nested_data = d3.nest()
                          .key(function(d){ return d.STRM; })
                          .key(function(d){ return d.plan_descr; })
                          .entries(data);
      flipped_data = d3.nest()
                          .key(function(d){ return d.plan_descr; })
                          .key(function(d){ return d.STRM; })
                          .entries(data);

      gender_data = d3.nest()
                          .key(function(d){ return d.plan_descr; })
                          .key(function(d){ return d.STRM; })
                          .key(function(d){ return d.GENDER_CD; })
                          .entries(data);

      ethnicity_data = d3.nest()
                          .key(function(d){ return d.plan_descr; })
                          .key(function(d){ return d.STRM; })
                          .key(function(d){ return d.Ethnicity_Code_EPM_SP; })
                          .entries(data);

      resident_data = d3.nest()
                          .key(function(d){ return d.plan_descr; })
                          .key(function(d){ return d.STRM; })
                          .key(function(d){ return d.UA_IPEDS_RESIDENCY; })
                          .entries(data);
                          

  y.domain([1, 
    d3.max(nested_data, 
      function(element, index, array) { 
        return d3.max(element.values,
          function(element, index, array){ return element.values.length; }
        );
      }
    )
  ]);


  d3.select("body").append("div").attr("id", "all_div").attr("class", "outerDiv");
  createLineGraph("all", flipped_data, '', "all_div");

  d3.select("body").append("div").attr("id", "gender_div").attr("class", "outerDiv");
  createLineGraph("males", gender_data, 'M', "gender_div");

  createLineGraph("females", gender_data, 'F', "gender_div");

  createDiffGraph("gender_diff", gender_data, 'MF', "gender_div");

  d3.select("body").append("div").attr("id", "ethnicity_div").attr("class", "outerDiv");
  createLineGraph("international", ethnicity_data, 'ALIEN', "ethnicity_div");

  createLineGraph("white", ethnicity_data, 'WHITE', "ethnicity_div");

  createLineGraph("hispanic", ethnicity_data, 'HISPA', "ethnicity_div");

  createLineGraph("other", ethnicity_data, 'OTHER', "ethnicity_div");

  createLineGraph("asian", ethnicity_data, 'ASIAN', "ethnicity_div");

  createLineGraph("black", ethnicity_data, 'BLACK', "ethnicity_div");

  d3.select("body").append("div").attr("id", "resident_div").attr("class", "outerDiv");
  createLineGraph("residents", resident_data, 'R', "resident_div");

  createLineGraph("nonresidents", resident_data, 'N', "resident_div");

  }
});

function createLineGraph(id, nestedData, currKey, outerDiv){

  //createTable(id);
  //d3.select("#" + outerDiv).append("h1").html(id);
  var svg = createSVG(id, outerDiv);
    createAxes(svg);
    createLines(svg, nestedData, currKey);
    addPoints(svg, currKey);
    addLabels(svg, currKey);
    addInteraction(svg, id);
}

function createDiffGraph(id, nestedData, currKey, outerDiv){
  var svg = createSVG(id, outerDiv);
  svg.append("g")
      .attr("class", "x_axis")
      .attr("transform", "translate(0," + height + ")")
      .call(diffxAxis);

  svg.append("g")
      .attr("class", "y_axis")
      .call(diffyAxis);
}

function wasClicked(id){
  d3.selectAll(".line")
  .style("stroke", "#d3d3d3");

  d3.selectAll(".point")
  .attr("visibility", "hidden");

  d3.selectAll(".label")
  .attr("visibility", "hidden");

  var currTable = d3.select("div").selectAll("#"+id).select("table");
  console.log(currTable);

  currTable.selectAll("#newRow").html("");

  // populate stats table
  var arr = clicked_major.selectAll("circle").data();
  var currVals = [];
  arr.forEach(function(element){ currVals.push(element.key); });
  //console.log(currVals);
  var allXValues = [ "2104", "2111", "2114", "2121", "2124", "2131", "2134", "2141", "2144", "2151" ];
  var i = 0;
  
  arr.forEach(function(element){
    while(i < allXValues.length){
      if(currVals.indexOf(allXValues[i]) < 0){
        currTable.select("#newRow").append("td").html("0");
        i++;
      }else{
        console.log(element.values.length);
        currTable.select("#newRow").append("td").html(element.values.length);
        i++;
        break;
      }
    }
  });

  for(; i < allXValues.length; i++)
    currTable.select("#newRow").append("td").text("0");

  clicked_major.selectAll(".line")
  .style("stroke", "#ff0000");

  clicked_major.selectAll(".point")
  .attr("visibility", "visible");

  clicked_major.selectAll(".label")
  .attr("visibility", "visible");

}

// function expandArray(currSet){
//   var allXValues = [ "2104", "2111", "2114", "2121", "2124", "2131", "2134", "2141", "2144", "2151"];
//   var emptyArray = [];
//   var currVals = [];
//   currSet.forEach(function(element){ currVals.push(element.key); });
//   allXValues.forEach(function(element){
//     if(currVals.indexOf(element) < 0)
//       currSet.push({ key: element, values: emptyArray });
//   });
//   console.log(currSet);
//   return currSet;
// }

function createTable(nameOfSVG){
  var div = d3.select("body")
    .append("div")
    .attr("width", 960)
    .attr("height", 100)
    .attr("id", nameOfSVG);

  var table = div.append("table");

  // add table
  var firstRow = table.append("tr");

  var allSemesters = ["F 10", 
        "S 11",
        "F 11",
        "S 12",
        "F 12",
        "S 13",
        "F 13",
        "S 14",
        "F 14",
        "S 15"];

  allSemesters.forEach(function(element){
    firstRow.append("th")
      .html(element);
  });

  var newRow = table.append("tr").attr("id", "newRow");

  allSemesters.forEach(function(element){
    newRow.append("td")
  });

}

function createSVG(nameOfSVG, outerDiv){
  
  var innerDiv = d3.select("#" + outerDiv).append("div").attr("class", "innerDiv");

  innerDiv.append("h1").html(nameOfSVG);

  var currSVG = innerDiv.append("svg")
  .attr("id", nameOfSVG)
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  return currSVG;
}

function createAxes(currSVG){

  currSVG.append("g")
      .attr("class", "x_axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .selectAll("text")
      .attr("x", -10)
      .attr("y", 0)
      .attr("transform", "rotate(-65)")
      .style("text-anchor", "end");

  currSVG.append("g")
      .attr("class", "y_axis")
      .call(yAxis);

}

function createLines(currSVG, currData, match){

  var relevantData;

  currSVG.selectAll(".major")
    .data(currData, function(d) { /*console.log(d.key);*/ return d.key; })
    .enter().append("g")
    .attr("class", "major")
    .attr("id", function(d){ 
      return getValidId(d.key);
    })
    .append("path")
    .attr("class", "line")
    .attr("d", function(d) { 
      // if(match == ''){
      //   relevantData = d.values;
      //   // console.log(currMajor);
      //   // if(currMajor == "Envr_Hydrology_and_Water_Res"){
      //   //   console.log(relevantData);
      //   // }
      //   // return line(relevantData); 
      // }else{
      //   relevantData = getRelevantData(d, match);
      //   // return line(relevantData);
      // }
      // // bindToId(relevantData, currMajor, currSVG);
      // return line(relevantData);

      if(match == ''){
        return line(d.values);
        // return line(relevantData); 
      }else{
        return line(getRelevantData(d, match));
        // return line(relevantData);
      }
    })
    .style("stroke", "#d3d3d3");



}

function getRelevantData(d, match) { 
      var oneLineArray = d.values;
      //console.log(oneLineArray);
      var newArray = [];
      oneLineArray.forEach( 
        function(element){
          // console.log(element.values);
          var anotherArray = element.values;
          var currSemester = element.key;
          anotherArray.forEach(
            function(elem){
              //console.log(elem.values);
              var studentsInMajor = elem.values;
              if(elem.key == match){
                newArray.push({ key: currSemester, values: studentsInMajor });
              }
            }
          );
        }
      );
      //console.log(newArray);
      return newArray; 
    }

function addPoints(currSVG, match){
  var pointsGroup = currSVG.selectAll(".major")
      .append("g");

    var innerPointSelection = pointsGroup.selectAll("circle");
    // console.log(innerPointSelection.data());
    innerPointSelection
      .data(function(d){ 
        // console.log("Key: " + d.key); 
        // console.log("Values: " + d.values); 
        if(match == ''){
          return /*expandArray(*/d.values/*)*/;
        }else{
          return getRelevantData(d, match);
        }
        // console.log(d);
        return d.values;
      })
      .enter().append("circle")
      .attr("class", "point")
      .attr("cx", function(d){ /*console.log(d.key);*/ return x(findSemester(d.key)); })
      .attr("cy", function(d){ /*console.log(d.values);*/ return y(d.values.length); })
      .attr("r", 7)
      .style("fill", "#ffffff")
      .style("stroke", "#20208b")
      .style("stroke-width", 3)
      .append("title")
      .text(function(d){
        return findSemester(d.key) + ": " + d.values.length;
      });

    currSVG.selectAll(".point")
      .attr("visibility", "hidden");
}

function addLabels(currSVG, match){
  var newText = currSVG.selectAll(".major").append("text").attr("class", "label").text(function(d){ return d.key; });

  // var newText = currSVG.selectAll(".major").append("div")
  //       // .attr("class", "hidden")
  //       .attr("id", "tooltip");

  //       newText
  //       .append("p")
  //       .text(function(d){ return d.key; });

    // newText.style("left", function(d){
      newText.attr("x", function(d){
      var allSemesters;
      if(match == '')
        allSemesters = d.values;
      else{
        allSemesters = getRelevantData(d, match);
        // console.log(allSemesters);
      }
      if(allSemesters.length != 0){
        var lastSemester = allSemesters[allSemesters.length - 1];
        return x(findSemester(lastSemester.key))+15;
      }else
        return 0;
    })
    // .style("top", function(d){
      .attr("y", function(d){
      var allSemesters;
      if(match == '')
        allSemesters = d.values;
      else
        allSemesters = getRelevantData(d, match);
      if(allSemesters.length != 0){
        var lastSemester = allSemesters[allSemesters.length - 1];
        return y(lastSemester.values.length);
      }else
        return 0;
    })
    .attr("visibility", "hidden");
}

function addInteraction(currSVG, id){

      currSVG.selectAll(".major")
        .on("mouseover", function(d) {
          // if(clicked_major == null || d3.select(this).data()[0].key != clicked_major.data()[0].key){
            
            //console.log(d3.select(this)[0][0].id);
            var currGId = d3.select(this)[0][0].id;
            var sameMajorForAll = d3.selectAll("#" + currGId);

            sameMajorForAll.selectAll(".line")
              .style("stroke", "#20208b");

            sameMajorForAll.selectAll(".point")
              .attr("visibility", "visible");

            // console.log(d);

            div.style("opacity", .9)
              .html(d.key)
              .style("left", (d3.event.pageX)+"px")
              .style("top", (d3.event.pageY - 28) + "px");

            // sameMajorForAll
            //   .select("text")
            //   .attr("visibility", "visible");

            // sameMajorForAll.select("#tooltip").classed("hidden", false);

          // }



            sameMajorForAll[0].forEach(function(element){
              element.parentElement.appendChild(element);
            });
          })
        // .on("click", function() {
        //     clicked_major = d3.select(this);

            // wasClicked(id);

          //   this.parentElement.appendChild(this);

          // })
        .on("mouseout", function(){
          // if(clicked_major == null || d3.select(this).data()[0].key != clicked_major.data()[0].key){
            var currGId = d3.select(this)[0][0].id;
            var sameMajorForAll = d3.selectAll("#" + currGId);

            sameMajorForAll.selectAll(".line")
            .style("stroke", "#d3d3d3");
            
            sameMajorForAll.selectAll(".point")
                .attr("visibility", "hidden");

            div.style("opacity", 0);

            // sameMajorForAll
            //     .select("text")
            //     .attr("visibility", "hidden");

            // sameMajorForAll.select("#tooltip").classed("hidden", true);
          // }
        });
}

function getValidId(majorName){
  majorName = majorName.replace(/ /g, "_");
  majorName = majorName.replace(/([,\/().'])/g, "");
  majorName = majorName.replace(/&/g, "and");
  return majorName;
}

function bindToId(relevantData, currMajor, currSVG){
  console.log(currMajor);
  currSVG.select("#" + currMajor).data(relevantData);
}

  </script>
</body>
</html>